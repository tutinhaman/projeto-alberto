{% extends 'base.html' %}

{% block title %}Relatorio Mensal{% endblock %}

{% block content %}
<section class="space-y-6">
  <h1 class="text-3xl font-bold mb-2 text-gray-800 text-center">Relatorio Mensal</h1>

  <form method="get" class="bg-white shadow-md rounded-xl p-6 max-w-3xl mx-auto">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label for="{{ form.mes.id_for_label }}" class="text-sm font-medium text-gray-600 mb-1 block">Mes</label>
        {{ form.mes }}
      </div>
      <div>
        <label for="{{ form.ano.id_for_label }}" class="text-sm font-medium text-gray-600 mb-1 block">Ano</label>
        {{ form.ano }}
      </div>
      <div>
        <label for="{{ form.almoxarifado.id_for_label }}" class="text-sm font-medium text-gray-600 mb-1 block">Almoxarifado</label>
        {{ form.almoxarifado }}
      </div>
      <div>
        <label for="{{ form.funcionario.id_for_label }}" class="text-sm font-medium text-gray-600 mb-1 block">Funcionario</label>
        {{ form.funcionario }}
      </div>
    </div>
    <div class="flex flex-wrap gap-3 mt-5">
      <button type="submit" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold px-4 py-2 rounded-md transition">
        Filtrar
      </button>
      <a href="{% url 'core:relatorio_mensal' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-4 py-2 rounded-md transition">
        Limpar
      </a>
    </div>
  </form>

  <div class="bg-blue-50 border-l-4 border-blue-600 p-4 rounded-lg shadow-sm">
    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h2 class="text-lg font-semibold text-blue-900">Resumo de {{ mes_selecionado|stringformat:"02d" }}/{{ ano_selecionado }}</h2>
        <p class="text-sm text-blue-900/80">Somente acessos encerrados no periodo selecionado</p>
      </div>
      <div class="flex flex-wrap gap-2 text-xs font-semibold text-blue-900">
        {% if filtros.almoxarifado %}<span class="bg-white/80 px-3 py-1 rounded-full border border-blue-200">Almoxarifado filtrado</span>{% endif %}
        {% if filtros.funcionario %}<span class="bg-white/80 px-3 py-1 rounded-full border border-blue-200">Funcionario filtrado</span>{% endif %}
      </div>
    </div>
    <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <p class="text-sm text-gray-600">Movimentacoes encerradas</p>
        <p class="text-2xl font-bold text-gray-900">{{ movimentacoes|length }}</p>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <p class="text-sm text-gray-600">Total retiradas</p>
        <p class="text-2xl font-bold text-gray-900">{{ totais.total_retiradas }}</p>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <p class="text-sm text-gray-600">Total devolucoes</p>
        <p class="text-2xl font-bold text-gray-900">{{ totais.total_devolucoes }}</p>
      </div>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
        <p class="text-sm text-gray-600">Saldo no periodo</p>
        {% if totais.saldo > 0 %}
        <p class="text-2xl font-bold text-red-600">{{ totais.saldo }}</p>
        <p class="text-xs text-red-600 font-semibold">Estoque reduziu</p>
        {% elif totais.saldo < 0 %}
        <p class="text-2xl font-bold text-green-700">{{ totais.saldo }}</p>
        <p class="text-xs text-green-700 font-semibold">Estoque aumentou</p>
        {% else %}
        <p class="text-2xl font-bold text-gray-900">{{ totais.saldo }}</p>
        <p class="text-xs text-gray-600 font-semibold">Sem variacao</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div>
    <h2 class="text-xl font-semibold text-gray-800 mb-2">Resumo por material</h2>
    {% if resumo_por_material %}
    <div class="overflow-x-auto">
      <table class="min-w-full border-collapse mt-4 bg-white rounded-lg overflow-hidden shadow-sm">
        <thead class="bg-blue-600 text-white text-sm font-semibold">
          <tr>
            <th class="px-4 py-3 text-left">Material</th>
            <th class="px-4 py-3 text-left">Retiradas</th>
            <th class="px-4 py-3 text-left">Devolucoes</th>
          </tr>
        </thead>
        <tbody class="text-sm text-gray-700">
          {% for item in resumo_por_material %}
          <tr class="odd:bg-white even:bg-gray-50 hover:bg-gray-100 transition">
            <td class="px-4 py-2">{{ item.material__nome }}</td>
            <td class="px-4 py-2">{{ item.retiradas|default_if_none:"0" }}</td>
            <td class="px-4 py-2">{{ item.devolucoes|default_if_none:"0" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-500">Nenhuma movimentacao registrada no periodo selecionado.</p>
    {% endif %}
  </div>

  <div>
    <h2 class="text-xl font-semibold text-gray-800 mb-2">Movimentacoes no periodo</h2>
    {% if movimentacoes %}
    <div class="overflow-x-auto">
      <table class="min-w-full border-collapse mt-2 bg-white rounded-lg overflow-hidden shadow-sm text-sm">
        <thead class="bg-blue-600 text-white font-semibold">
          <tr>
            <th class="px-4 py-3 text-left">Data</th>
            <th class="px-4 py-3 text-left">Funcionario</th>
            <th class="px-4 py-3 text-left">Material</th>
            <th class="px-4 py-3 text-left">Tipo de acesso</th>
            <th class="px-4 py-3 text-left">Tipo</th>
            <th class="px-4 py-3 text-left">Justificativa</th>
            <th class="px-4 py-3 text-right">Quantidade</th>
          </tr>
        </thead>
        <tbody>
          {% for movimentacao in movimentacoes %}
          <tr class="odd:bg-white even:bg-gray-50 hover:bg-gray-100 transition">
            <td class="px-4 py-2">{{ movimentacao.acesso.data_hora|date:"d/m/Y H:i" }}</td>
            <td class="px-4 py-2">{{ movimentacao.acesso.funcionario.nome }}</td>
            <td class="px-4 py-2">{{ movimentacao.material.nome }}</td>
            <td class="px-4 py-2">
              {% if movimentacao.acesso.tipo == 'entrada' %}
              <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Entrada</span>
              {% else %}
              <span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs font-semibold">Saida</span>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% if movimentacao.tipo == 'retirada' %}
              <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-semibold">Retirada</span>
              {% else %}
              <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-semibold">Devolucao</span>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {{ movimentacao.acesso.get_justificativa_padrao_display }}
              {% if movimentacao.acesso.observacao %}
              <br />
              <span class="text-gray-500 text-xs">Obs.: {{ movimentacao.acesso.observacao }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-2 text-right font-semibold text-gray-900">{{ movimentacao.quantidade }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-500">Nao ha movimentacoes registradas neste periodo.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
